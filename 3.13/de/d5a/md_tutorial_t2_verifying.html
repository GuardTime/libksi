<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Guardtime KSI c SDK: T2 - Verifying Tutorial</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Guardtime KSI c SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">T2 - Verifying Tutorial </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Disclaimer </h2>
<p>For simplicity reasons, the error handling in this tutorial is mostly omitted. In practice almost all the functions in the SDK return a status code which value should be checked to be <a class="el" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>, which means all went well.</p>
<h2>1. Preparation </h2>
<p>For preparation see <a class="el" href="../../dd/d52/md_tutorial_t0_basics.html">Basics Tutorial</a>.</p>
<h2>2. Parsing </h2>
<p>Usually if a signature needs to be verified, it has been serialized into a binary format which is stored in a file or database. We won't cover reading the binary data, as it may vary on different integrations. Let's assume the signature is copied into a buffer called <code>raw</code> and it's length is stored in <code>raw_len</code>. To parse the signature we need to call <a class="el" href="../../da/d4f/group__signature.html#ga4c88395579b0262a5c75563838ce6534">KSI_Signature_parse</a>:</p>
<div class="fragment"><div class="line"><a class="code" href="../../df/d8a/group__ksi__types.html#gaec1ceb681237b74b978a661bb3224cb2">KSI_Signature</a> *sig = NULL;</div><div class="line"><a class="code" href="../../da/d4f/group__signature.html#ga4c88395579b0262a5c75563838ce6534">KSI_Signature_parse</a>(ksi, raw, raw_len, &amp;sig);</div></div><!-- fragment --><p>After a successful call to <a class="el" href="../../da/d4f/group__signature.html#ga4c88395579b0262a5c75563838ce6534">KSI_Signature_parse</a> the buffer <code>raw</code> can be freed by the caller as it is not referenced by the signature.</p>
<h2>3. Simple verification </h2>
<p>For the most basic verification needs we can just call <a class="el" href="../../dd/df2/group__base.html#ga490cd1d645a2ceadfbfb746c5867c9a7">KSI_verifySignature</a> and check that the return code is <a class="el" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>:</p>
<div class="fragment"><div class="line">res = <a class="code" href="../../dd/df2/group__base.html#ga490cd1d645a2ceadfbfb746c5867c9a7">KSI_verifySignature</a>(ksi, sig);</div><div class="line"><span class="keywordflow">if</span> (res == <a class="code" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>) {</div><div class="line">        printf(<span class="stringliteral">&quot;Signature successfully verified!\n&quot;</span>);</div><div class="line">} <span class="keywordflow">else</span> {</div><div class="line">        printf(<span class="stringliteral">&quot;Signature verification failed!\n&quot;</span>);</div><div class="line">}</div></div><!-- fragment --><p>In the above example we didn't verify the signature against the original document. However we can do so by calling <a class="el" href="../../d9/d3e/signature__helper_8h.html#ae00fb0a16ec9979cfbcd9b50c594af2f">KSI_Signature_verifyDocument</a>. The document is pointed to by <code>doc</code> and its length is given in <code>doc_len:</code> </p>
<div class="fragment"><div class="line">res = <a class="code" href="../../d9/d3e/signature__helper_8h.html#ae00fb0a16ec9979cfbcd9b50c594af2f">KSI_Signature_verifyDocument</a>(sig, ksi, doc, doc_len);</div><div class="line"><span class="keywordflow">if</span> (res == <a class="code" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>) {</div><div class="line">        printf(<span class="stringliteral">&quot;Signature and document successfully verified!\n&quot;</span>);</div><div class="line">} <span class="keywordflow">else</span> {</div><div class="line">        printf(<span class="stringliteral">&quot;Signature and document verification failed!\n&quot;</span>);</div><div class="line">}</div></div><!-- fragment --><p>Alternatively, if we already have a document hash available in <code>hsh</code>, we can simply call <a class="el" href="../../dd/df2/group__base.html#ga925c076b82c37294982efbbee41e571b">KSI_verifyDataHash</a>:</p>
<div class="fragment"><div class="line">res = <a class="code" href="../../dd/df2/group__base.html#ga925c076b82c37294982efbbee41e571b">KSI_verifyDataHash</a>(ksi, sig, hsh);</div><div class="line"><span class="keywordflow">if</span> (res == <a class="code" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>) {</div><div class="line">        printf(<span class="stringliteral">&quot;Signature and document successfully verified!\n&quot;</span>);</div><div class="line">} <span class="keywordflow">else</span> {</div><div class="line">        printf(<span class="stringliteral">&quot;Signature and document verification failed!\n&quot;</span>);</div><div class="line">}</div></div><!-- fragment --><p>Abovemnetioned examples in this chapter used the general verification policy implicitly (see next chapter for details) and relied on a pre-configured publications file and extender in KSI context. If this is all we need and we are not interested in the details of the verification result (e.g. in case of a failure), then that's all we need to know about the verification!</p>
<p>If however we want more control over the verification process, we can choose the verification policy explicitly and provide relevant input data in the verification context. All of this is explained in the following chapters.</p>
<h2>4. Policies </h2>
<p>Signatures are verified according to one or more policies (even in the simple examples of the previous chapter). A verification policy is a set of ordered rules that verify relevant signature properties. Verifying a signature according to a policy results in one of three possible outcomes:</p><ul>
<li>Verification is successful, which means that there is enough data to prove that the signature is correct.</li>
<li>Verification is not possible, which means that there is not enough data to prove or disprove the correctness of the signature. Note: with some other policy it might still be possible to prove the correctness of the signature.</li>
<li>Verification failed, which means that the signature is definitely invalid or the document does not match the signature.</li>
</ul>
<p>The SDK provides the following predefined policies for verification:</p><ul>
<li>Internal policy. This policy verifies the consistency of various internal components of the signature without requiring any additional data from the user. The verified components are the aggregation chain, calendar chain (optional), calendar authentication record (optional) and publication record (optional). Additionally, if a document hash is provided, the signature is verified against it.</li>
<li>User provided publication string based policy. This policy verifies the signature publication record against the publication string. if necessary (and permitted), the signature is extended to the user publication. For conclusive results the signature must either contain a publication record with a suitable publication or signature extending must be allowed. A publication string must be provided and an extender must be configured.</li>
<li>Publications file based policy. This policy verifies the signature publication record against a publication in the publication file. If necessary (and permitted), the signature is extended to the publication. For conclusive results the signature must either contain a publication record with a suitable publication or signature extending must be allowed. A publications file must be provided for lookup and an extender must be configured.</li>
<li>Key-based policy. This policy verifies the PKI signature and calendar chain data in the calendar authentication record of the signature. For conclusive results, a calendar hash chain and calendar authentication record must be present in the signature. A trusted publication file must be provided for performing lookup of a matching certificate.</li>
<li>Calendar-based policy. This policy first extends the signature to either the head of the calendar or to the same time as the calendar chain of the signature. The extended signature calendar chain is then verified against aggregation chain of the signature. For conclusive results the extender must be configured.</li>
<li>General policy. This policy uses all the previously mentioned policies in the specified order. Verification starts off with internal verification and if successful, continues with key-based, publication-based and/or calendar-based verification, depending on the availability of calendar chain, calendar authentication record or publication record in the signature. The general policy tries all available verification policies until a signature correctness is proved or disproved and is thus the recommended policy for verification unless some restriction dictates the use of a specific verification policy.</li>
</ul>
<p>Note: all of the policies perform internal verification as a prerequisite to the specific verification and a policy will never result in a success if internal verification fails.</p>
<h2>5. Verifying a signature according to a policy </h2>
<p>To perform verification according to a policy, we first need to set up a verification context. To do this, we first call <a class="el" href="../../d0/d30/policy_8h.html#ada363ed08c8cd96fcdfbd825a694d792">KSI_VerificationContext_init</a> to initialize our context variable with default values. Then, by using our favorite API method, we obtain the signature that we want to verify and assign it directly into the verification context. Let's assume that our signature contains a publication record and we have a recent enough publication file to possibly contain the same publication. We obtain the publications file by using our API method of choice and assign it directly into the verification context. For now we have set up all the required information to perform the verification, so we can verify the signature by calling <a class="el" href="../../d0/d30/policy_8h.html#a0bbd308fbf1fcd368cd808a434d51163">KSI_SignatureVerifier_verify</a>. We get two kinds of information from this function. First, the functions returns a status code that indicates verification completeness. Under normal circumstances the return code should be <a class="el" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>, meaning that the verification process was completed without any errors (e.g. invalid parameters, out of memory errors, extender errors, etc). Second, the function creates a verification result that contains the actual result of the verification according to our chosen policy. As mentioned before, the result can be a success or failure if there was enough data to verify the signature or inconclusive if there was not enough data (e.g. no publication file configured) Note: <a class="el" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a> alone as a positive status code does not indicate a successful verification result (although it is a prerequisite), so we must inspect the verification result for details:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> res; <span class="comment">/* The return value. */</span></div><div class="line"><a class="code" href="../../dc/d4b/structKSI__VerificationContext__st.html">KSI_VerificationContext</a> context;</div><div class="line"><a class="code" href="../../dd/da6/structKSI__PolicyVerificationResult__st.html">KSI_PolicyVerificationResult</a> *result = NULL; <span class="comment">/* Must be freed. */</span></div><div class="line"></div><div class="line">res = <a class="code" href="../../d0/d30/policy_8h.html#ada363ed08c8cd96fcdfbd825a694d792">KSI_VerificationContext_init</a>(&amp;context, ksi);</div><div class="line">res = <a class="code" href="../../d9/d3e/signature__helper_8h.html#a95406c0222d83bc130dd415c080f2395">KSI_Signature_fromFile</a>(ksi, getFullResourcePath(<span class="stringliteral">&quot;some_signature.ksig&quot;</span>), &amp;context.<a class="code" href="../../dc/d4b/structKSI__VerificationContext__st.html#a36f4e027eec3fd6caadbe3461b5d90a4">signature</a>);</div><div class="line">res = <a class="code" href="../../d4/d99/group__publications.html#ga5c2d2a3061a97841e3afc2fbcb8f7644">KSI_PublicationsFile_fromFile</a>(ksi, getFullResourcePath(<span class="stringliteral">&quot;ksi-publications.bin&quot;</span>), &amp;context.<a class="code" href="../../dc/d4b/structKSI__VerificationContext__st.html#a3ad6793365f0cc2e3f4aa70b0308f3df">userPublicationsFile</a>);</div><div class="line"><span class="comment">/* Verify the signature according to general policy. */</span></div><div class="line">res = <a class="code" href="../../d0/d30/policy_8h.html#a0bbd308fbf1fcd368cd808a434d51163">KSI_SignatureVerifier_verify</a>(KSI_VERIFICATION_POLICY_GENERAL, &amp;context, &amp;result);</div><div class="line"><span class="keywordflow">if</span> (res == <a class="code" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>) {</div><div class="line">        <span class="keywordflow">if</span> (result-&gt;<a class="code" href="../../dd/da6/structKSI__PolicyVerificationResult__st.html#a0b47203310fdc060d89112e17b18fc99">finalResult</a>.<a class="code" href="../../de/df9/structKSI__RuleVerificationResult__st.html#acfa02ac7d150b81a81e3e42cae429e4a">resultCode</a> == <a class="code" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3da81cbad1994b3f8a0eea1f238fed94c2e">KSI_VER_RES_OK</a>)</div><div class="line">                printf(<span class="stringliteral">&quot;Signature verified successfully!\n&quot;</span>);</div><div class="line">        } <span class="keywordflow">else</span> {</div><div class="line">                <span class="comment">/* Error handling. Verification failed or was inconclusive. */</span></div><div class="line">                <span class="comment">/* Check result-&gt;finalResult.errorCode for error code. */</span></div><div class="line">        }</div><div class="line">} <span class="keywordflow">else</span> {</div><div class="line">        <span class="comment">/* Error handling. Verification not completed due to internal error. */</span></div><div class="line">}</div></div><!-- fragment --><h2>6. Verification context </h2>
<p>The key to conclusive verification is having sufficient information set up in the verification context without assuming too much from the signature itself. For most cases this means that we have to set up a publications file in the verification context and configure an extender (see <a class="el" href="../../dd/d52/md_tutorial_t0_basics.html">Basics Tutorial</a>). In some cases (see example below) we need to allow extending as well. If we want to verify the signature against a specific publication, we can do so by setting up the publication string in the verification context. If we want to verify the signature against a document, the document hash can be stored in the verification context. Additionally, the verification context can be used for specifying the initial aggregation level and enabling/disabling extending for publication-based verification.</p>
<p>Let's continue with another example where we want to verify the signature against a specific publication. We don't really need any of the other verification policies, so we can use the predefined policy #KSI_VERIFICATION_POLICY_USER_PUBLICATION_BASED. For conclusive results we need to set up the publication string in the verification context:</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> pubString[] = <span class="stringliteral">&quot;AAAAAA-CUCYWA-AAOBM6-PNYLRK-EPI3VG-2PJGCF-Y5QHV3-XURLI2-GRFBK4-VHBED2-Q37QIB-UE3ENA&quot;</span>;</div><div class="line"></div><div class="line">res = <a class="code" href="../../d0/d30/policy_8h.html#ada363ed08c8cd96fcdfbd825a694d792">KSI_VerificationContext_init</a>(&amp;context, ksi);</div><div class="line">res = <a class="code" href="../../d9/d3e/signature__helper_8h.html#a95406c0222d83bc130dd415c080f2395">KSI_Signature_fromFile</a>(ksi, getFullResourcePath(<span class="stringliteral">&quot;some_signature.ksig&quot;</span>), &amp;context.<a class="code" href="../../dc/d4b/structKSI__VerificationContext__st.html#a36f4e027eec3fd6caadbe3461b5d90a4">signature</a>);</div><div class="line">res = <a class="code" href="../../d4/d99/group__publications.html#gafa4e623e0e3b65ef2c7aedda9e338225">KSI_PublicationData_fromBase32</a>(ksi, pubString, &amp;context.<a class="code" href="../../dc/d4b/structKSI__VerificationContext__st.html#a518c20afca053f7d7b65b7908770649d">userPublication</a>);</div><div class="line">res = <a class="code" href="../../d0/d30/policy_8h.html#a0bbd308fbf1fcd368cd808a434d51163">KSI_SignatureVerifier_verify</a>(KSI_VERIFICATION_POLICY_USER_PUBLICATION_BASED, &amp;context, &amp;result);</div><div class="line"><span class="keywordflow">if</span> (res == <a class="code" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>) {</div><div class="line">        <span class="keywordflow">if</span> (result-&gt;<a class="code" href="../../dd/da6/structKSI__PolicyVerificationResult__st.html#a0b47203310fdc060d89112e17b18fc99">finalResult</a>.<a class="code" href="../../de/df9/structKSI__RuleVerificationResult__st.html#acfa02ac7d150b81a81e3e42cae429e4a">resultCode</a> == <a class="code" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3da81cbad1994b3f8a0eea1f238fed94c2e">KSI_VER_RES_OK</a>)</div><div class="line">                printf(<span class="stringliteral">&quot;Signature verified successfully!\n&quot;</span>);</div><div class="line">        } <span class="keywordflow">else</span> {</div><div class="line">                <span class="comment">/* Error handling. Verification failed or was inconclusive. */</span></div><div class="line">                <span class="comment">/* Check result-&gt;finalResult.errorCode for error code. */</span></div><div class="line">        }</div><div class="line">} <span class="keywordflow">else</span> {</div><div class="line">        <span class="comment">/* Error handling. Verification not completed due to internal error. */</span></div><div class="line">}</div></div><!-- fragment --><p>If we want to rely on the key-based policy, we must set up the publications file as shown in the above examples. The only time we don't need a publication file or string is when we perform calendar-based verification. However we do need a valid extender for the online verification. The corresponding verification calls:</p>
<div class="fragment"><div class="line">res = <a class="code" href="../../d0/d30/policy_8h.html#a0bbd308fbf1fcd368cd808a434d51163">KSI_SignatureVerifier_verify</a>(KSI_VERIFICATION_POLICY_KEY_BASED , &amp;context, &amp;result);</div><div class="line">res = <a class="code" href="../../d0/d30/policy_8h.html#a0bbd308fbf1fcd368cd808a434d51163">KSI_SignatureVerifier_verify</a>(KSI_VERIFICATION_POLICY_CALENDAR_BASED, &amp;context, &amp;result);</div></div><!-- fragment --><p>For allowing extending of a signature for publication based policies, we have to enable it in the verification context. By default the extending is not allowed, which in some situations is what we want, but in other situations can lead to inconclusive verification results if a suitable publication is not found. Note: if extending is allowed, a valid extender should also be configured (see <a class="el" href="../../dd/d52/md_tutorial_t0_basics.html">Basics Tutorial</a>).</p>
<div class="fragment"><div class="line"><span class="comment">/* Any non-zero value allows extending, zero disables extending. */</span></div><div class="line">context.<a class="code" href="../../dc/d4b/structKSI__VerificationContext__st.html#a106501b4415b2d791d1e49cfb9b905ce">extendingAllowed</a> = 1;</div></div><!-- fragment --><p>If we need to verify a signature with an aggregation level other than the default 0, we can specify this in the verification context. Initial aggregation level cannot be greater than 0xFF:</p>
<div class="fragment"><div class="line">context.docAggrLevel = 10;</div></div><!-- fragment --><p>For verifying the document, we need to set up the document hash in the verification context. The document hash, if set up, will be verified as part of all predefined policies, but for the sake of a simple example we will choose the internal policy:</p>
<div class="fragment"><div class="line">res = <a class="code" href="../../d0/d30/policy_8h.html#ada363ed08c8cd96fcdfbd825a694d792">KSI_VerificationContext_init</a>(&amp;context, ksi);</div><div class="line">res = <a class="code" href="../../d9/d3e/signature__helper_8h.html#a95406c0222d83bc130dd415c080f2395">KSI_Signature_fromFile</a>(ksi, getFullResourcePath(<span class="stringliteral">&quot;some_signature.ksig&quot;</span>), &amp;context.<a class="code" href="../../dc/d4b/structKSI__VerificationContext__st.html#a36f4e027eec3fd6caadbe3461b5d90a4">signature</a>);</div><div class="line">context.<a class="code" href="../../dc/d4b/structKSI__VerificationContext__st.html#a8d36f656a5c36977d45533bf8e818232">documentHash</a> = document_hash;</div><div class="line">res = <a class="code" href="../../d0/d30/policy_8h.html#a0bbd308fbf1fcd368cd808a434d51163">KSI_SignatureVerifier_verify</a>(KSI_VERIFICATION_POLICY_INTERNAL, &amp;context, &amp;result);</div><div class="line"><span class="keywordflow">if</span> (res == <a class="code" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>) {</div><div class="line">        <span class="keywordflow">if</span> (result-&gt;<a class="code" href="../../dd/da6/structKSI__PolicyVerificationResult__st.html#a0b47203310fdc060d89112e17b18fc99">finalResult</a>.<a class="code" href="../../de/df9/structKSI__RuleVerificationResult__st.html#acfa02ac7d150b81a81e3e42cae429e4a">resultCode</a> == <a class="code" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3da81cbad1994b3f8a0eea1f238fed94c2e">KSI_VER_RES_OK</a>)</div><div class="line">                printf(<span class="stringliteral">&quot;Signature verified successfully!\n&quot;</span>);</div><div class="line">        } <span class="keywordflow">else</span> {</div><div class="line">                <span class="comment">/* Error handling. Verification failed or was inconclusive. */</span></div><div class="line">                <span class="comment">/* Check result-&gt;finalResult.errorCode for error code. */</span></div><div class="line">        }</div><div class="line">} <span class="keywordflow">else</span> {</div><div class="line">        <span class="comment">/* Error handling. Verification not completed due to internal error. */</span></div><div class="line">}</div></div><!-- fragment --><h2>7. Inspecting the result of verification </h2>
<p>As mentioned before, the prerequisite of a conclusive verification result is that <a class="el" href="../../d0/d30/policy_8h.html#a0bbd308fbf1fcd368cd808a434d51163">KSI_SignatureVerifier_verify</a> returns <a class="el" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>. If the return code is other than <a class="el" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>, e.g. <a class="el" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a9760985819768d47b4772742f5316a8e">KSI_INVALID_ARGUMENT</a> or <a class="el" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a6df1988ed56beb0758df9eeb1ecd9b32">KSI_OUT_OF_MEMORY</a>, the verification process was not completed and it is not possible to say if the signature is valid or incorrect. If however <a class="el" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a> is returned, we must evaluate the <code>result</code> object, which is created by <a class="el" href="../../d0/d30/policy_8h.html#a0bbd308fbf1fcd368cd808a434d51163">KSI_SignatureVerifier_verify</a>. Only then can we say if the verification was a success or failure.</p>
<div class="fragment"><div class="line">res = <a class="code" href="../../d0/d30/policy_8h.html#a0bbd308fbf1fcd368cd808a434d51163">KSI_SignatureVerifier_verify</a>(KSI_VERIFICATION_POLICY_GENERAL, &amp;context, &amp;result);</div><div class="line"><span class="keywordflow">if</span> (res == <a class="code" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>) {</div><div class="line">        <span class="comment">/* Verification process was completed without errors, inspect the result. */</span></div><div class="line">        <span class="keywordflow">switch</span> (result-&gt;<a class="code" href="../../dd/da6/structKSI__PolicyVerificationResult__st.html#a0b47203310fdc060d89112e17b18fc99">finalResult</a>.<a class="code" href="../../de/df9/structKSI__RuleVerificationResult__st.html#acfa02ac7d150b81a81e3e42cae429e4a">resultCode</a>) {</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3da81cbad1994b3f8a0eea1f238fed94c2e">KSI_VER_RES_OK</a>:</div><div class="line">                        printf(<span class="stringliteral">&quot;Verification successful, signature is valid.\n&quot;</span>);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3daf8eab89825e59206118d3c39365f282e">KSI_VER_RES_FAIL</a>:</div><div class="line">                        printf(<span class="stringliteral">&quot;Verification failed, signature is not valid.\n&quot;</span>);</div><div class="line">                        printf(<span class="stringliteral">&quot;Verification error code: %d\n&quot;</span>, result-&gt;<a class="code" href="../../dd/da6/structKSI__PolicyVerificationResult__st.html#a0b47203310fdc060d89112e17b18fc99">finalResult</a>.<a class="code" href="../../de/df9/structKSI__RuleVerificationResult__st.html#a1428e3d9deed6970e943f7a3414d3f45">errorCode</a>);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3da7e8591aa9bb04b46f1b48afa5b0236b3">KSI_VER_RES_NA</a>:</div><div class="line">                        printf(<span class="stringliteral">&quot;Verification inconclusive, not enough data to prove or disprove signature correctness.\n&quot;</span>);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">} <span class="keywordflow">else</span> {</div><div class="line">        printf(<span class="stringliteral">&quot;Unable to complete verification due to an internal error: %x.\n&quot;</span>, res);</div><div class="line">        printf(<span class="stringliteral">&quot;Error description: %s\n&quot;</span>, <a class="code" href="../../dd/df2/group__base.html#gadfe46106680ae0a9820142c4bcd0ef49">KSI_getErrorString</a>(res));</div><div class="line">}</div></div><!-- fragment --><h2>8. Cleanup </h2>
<p>As the final step we need to free all the allocated resources. As an owner of all the resources that we set in the verification context (signature, document hash, publication file/string), we are responsible for freeing them. The verification context contains temporary data that is allocated during verification and this must be freed by calling <a class="el" href="../../d0/d30/policy_8h.html#a3a807836e1c590e80092591b1b808c91">KSI_VerificationContext_clean</a>. After we are done inspecting the verification result, we must free it with <a class="el" href="../../d0/d30/policy_8h.html#a7eb13fef64ac082afc9776c0d40d24f6">KSI_PolicyVerificationResult_free</a>.</p>
<p>Note that the KSI context may be reused as much as needed (within a single thread) and must not be created every time. It is also important to point out that the context, if freed, must be freed last.</p>
<div class="fragment"><div class="line"><a class="code" href="../../da/d4f/group__signature.html#ga4d14e3cb5ca06780d492746d58de92dd">KSI_Signature_free</a>(context.<a class="code" href="../../dc/d4b/structKSI__VerificationContext__st.html#a36f4e027eec3fd6caadbe3461b5d90a4">signature</a>);</div><div class="line"><a class="code" href="../../d0/d30/policy_8h.html#a3a807836e1c590e80092591b1b808c91">KSI_VerificationContext_clean</a>(&amp;context);</div><div class="line"><a class="code" href="../../d0/d30/policy_8h.html#a7eb13fef64ac082afc9776c0d40d24f6">KSI_PolicyVerificationResult_free</a>(result);</div><div class="line"><a class="code" href="../../dd/df2/group__base.html#ga40d9e85aa8b1bd9218e8395e5a79838a">KSI_CTX_free</a>(ksi); <span class="comment">/* Must be freed last. */</span></div></div><!-- fragment --><h2>9. Migrating to the new verification functionality </h2>
<p>The above described new policy-based verification replaces the old verification functionality. In particular, the following interfaces are deprecated and will be removed from future SDK releases:</p>
<ul>
<li>int KSI_Signature_verify(KSI_Signature *sig, KSI_CTX *ctx)</li>
<li>int KSI_Signature_verifyAggregated(KSI_Signature *sig, KSI_CTX *ctx, KSI_uint64_t level)</li>
<li>int KSI_Signature_verifyOnline(KSI_Signature *sig, KSI_CTX *ctx)</li>
<li>int KSI_Signature_verifyDataHash(KSI_Signature *sig, KSI_CTX *ctx, KSI_DataHash *docHash)</li>
<li>int KSI_Signature_verifyWithPublication(KSI_Signature *sig, KSI_CTX *ctx, const KSI_PublicationData *publication)</li>
<li>int KSI_Signature_verifyAggregatedHash(KSI_Signature *sig, KSI_CTX *ctx, KSI_DataHash *rootHash, KSI_uint64_t rootLevel)</li>
<li>int KSI_Signature_getVerificationResult(KSI_Signature *sig, const KSI_VerificationResult **info)</li>
</ul>
<p>When replacing the usage of deprecated verification functionality, we need to choose a policy that matches that of the deprecated functionality and then set up the relevant data in the verification context. A straightforward replacement exists for KSI_Signature_verify - just use <a class="el" href="../../dd/df2/group__base.html#ga490cd1d645a2ceadfbfb746c5867c9a7">KSI_verifySignature</a> as shown in chapter 3. We will show how to replace the remaining functionalities. Note: for brevity, all error handling has been removed in the following examples.</p>
<div class="fragment"><div class="line"><span class="comment">/* Choose the general policy if you plan to replace one of the following: */</span></div><div class="line"><span class="comment">/* KSI_Signature_verifyAggregated */</span></div><div class="line"><span class="comment">/* KSI_Signature_verifyDataHash */</span></div><div class="line"><span class="comment">/* KSI_Signature_verifyAggregatedHash */</span></div><div class="line"><a class="code" href="../../d0/d30/policy_8h.html#a0bbd308fbf1fcd368cd808a434d51163">KSI_SignatureVerifier_verify</a>(KSI_VERIFICATION_POLICY_GENERAL, &amp;context, &amp;result);</div><div class="line"></div><div class="line"><span class="comment">/* Choose the calendar-based policy if you plan to replace: */</span></div><div class="line"><span class="comment">/* KSI_Signature_verifyOnline */</span></div><div class="line"><a class="code" href="../../d0/d30/policy_8h.html#a0bbd308fbf1fcd368cd808a434d51163">KSI_SignatureVerifier_verify</a>(KSI_VERIFICATION_POLICY_CALENDAR_BASED, &amp;context, &amp;result);</div><div class="line"></div><div class="line"><span class="comment">/* Choose the user provided publication based policy if you plan to replace: */</span></div><div class="line"><span class="comment">/* KSI_Signature_verifyWithPublication */</span></div><div class="line"><a class="code" href="../../d0/d30/policy_8h.html#a0bbd308fbf1fcd368cd808a434d51163">KSI_SignatureVerifier_verify</a>(KSI_VERIFICATION_POLICY_USER_PUBLICATION_BASED, &amp;context, &amp;result);</div></div><!-- fragment --><p>Depending on the chosen policy we need to set up relevant data in the verification context:</p>
<div class="fragment"><div class="line"><span class="comment">/* The signature is the only mandatory component in the verification context. */</span></div><div class="line"><span class="comment">/* Perform these steps for all chosen policies. */</span></div><div class="line"><a class="code" href="../../d0/d30/policy_8h.html#ada363ed08c8cd96fcdfbd825a694d792">KSI_VerificationContext_init</a>(&amp;context, ksi);</div><div class="line">context.<a class="code" href="../../dc/d4b/structKSI__VerificationContext__st.html#a36f4e027eec3fd6caadbe3461b5d90a4">signature</a> = sig;</div><div class="line"></div><div class="line"><span class="comment">/* Set the publications file if you plan to replace one of the following: */</span></div><div class="line"><span class="comment">/* KSI_Signature_verifyAggregated */</span></div><div class="line"><span class="comment">/* KSI_Signature_verifyDataHash */</span></div><div class="line"><span class="comment">/* KSI_Signature_verifyAggregatedHash */</span></div><div class="line">context.<a class="code" href="../../dc/d4b/structKSI__VerificationContext__st.html#a3ad6793365f0cc2e3f4aa70b0308f3df">userPublicationsFile</a> = pubFile;</div><div class="line"></div><div class="line"><span class="comment">/* Set the publication string if you plan to replace: */</span></div><div class="line"><span class="comment">/* KSI_Signature_verifyWithPublication */</span></div><div class="line">context.<a class="code" href="../../dc/d4b/structKSI__VerificationContext__st.html#a518c20afca053f7d7b65b7908770649d">userPublication</a> = pubString;</div><div class="line"></div><div class="line"><span class="comment">/* By default extending is not allowed in a publication based policy. */</span></div><div class="line"><span class="comment">/* If needed, you can allow extending when replacing one of the following: */</span></div><div class="line"><span class="comment">/* KSI_Signature_verifyAggregated */</span></div><div class="line"><span class="comment">/* KSI_Signature_verifyDataHash */</span></div><div class="line"><span class="comment">/* KSI_Signature_verifyAggregatedHash */</span></div><div class="line"><span class="comment">/* KSI_Signature_verifyWithPublication */</span></div><div class="line">context.<a class="code" href="../../dc/d4b/structKSI__VerificationContext__st.html#a106501b4415b2d791d1e49cfb9b905ce">extendingAllowed</a> = 1;</div><div class="line"></div><div class="line"><span class="comment">/* Set the document hash if you plan to replace one of the following: */</span></div><div class="line"><span class="comment">/* KSI_Signature_verifyDataHash */</span></div><div class="line"><span class="comment">/* KSI_Signature_verifyAggregatedHash */</span></div><div class="line">context.<a class="code" href="../../dc/d4b/structKSI__VerificationContext__st.html#a8d36f656a5c36977d45533bf8e818232">documentHash</a> = hsh;</div><div class="line"></div><div class="line"><span class="comment">/* By default the initial aggregation level is 0. */</span></div><div class="line"><span class="comment">/* If needed, set a different initial aggregation level if you plan to replace one of the following: */</span></div><div class="line"><span class="comment">/* KSI_Signature_verifyAggregated */</span></div><div class="line"><span class="comment">/* KSI_Signature_verifyAggregatedHash */</span></div><div class="line">context.docAggrLevel = level;</div></div><!-- fragment --><p>The verification result is an output parameter of <a class="el" href="../../d0/d30/policy_8h.html#a0bbd308fbf1fcd368cd808a434d51163">KSI_SignatureVerifier_verify</a>, so the KSI_Signature_getVerificationResult interface is now obsolete. A typical verification result inspection could look like this:</p>
<div class="fragment"><div class="line">res = <a class="code" href="../../d0/d30/policy_8h.html#a0bbd308fbf1fcd368cd808a434d51163">KSI_SignatureVerifier_verify</a>(KSI_VERIFICATION_POLICY_GENERAL, &amp;context, &amp;result);</div><div class="line"><span class="keywordflow">if</span> (res == <a class="code" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>) {</div><div class="line">        <span class="keywordflow">switch</span> (result-&gt;<a class="code" href="../../dd/da6/structKSI__PolicyVerificationResult__st.html#a0b47203310fdc060d89112e17b18fc99">finalResult</a>.<a class="code" href="../../de/df9/structKSI__RuleVerificationResult__st.html#acfa02ac7d150b81a81e3e42cae429e4a">resultCode</a>) {</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3da81cbad1994b3f8a0eea1f238fed94c2e">KSI_VER_RES_OK</a>:</div><div class="line">                        printf(<span class="stringliteral">&quot;Verification successful, signature is valid.\n&quot;</span>);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3daf8eab89825e59206118d3c39365f282e">KSI_VER_RES_FAIL</a>:</div><div class="line">                        printf(<span class="stringliteral">&quot;Verification failed, signature is not valid.\n&quot;</span>);</div><div class="line">                        printf(<span class="stringliteral">&quot;Verification error code: %d\n&quot;</span>, result-&gt;<a class="code" href="../../dd/da6/structKSI__PolicyVerificationResult__st.html#a0b47203310fdc060d89112e17b18fc99">finalResult</a>.<a class="code" href="../../de/df9/structKSI__RuleVerificationResult__st.html#a1428e3d9deed6970e943f7a3414d3f45">errorCode</a>);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3da7e8591aa9bb04b46f1b48afa5b0236b3">KSI_VER_RES_NA</a>:</div><div class="line">                        printf(<span class="stringliteral">&quot;Verification inconclusive, not enough data to prove or disprove signature correctness.\n&quot;</span>);</div><div class="line">                        <span class="keywordflow">break</span>;</div><div class="line">} <span class="keywordflow">else</span> {</div><div class="line">        <span class="comment">/* Error handling, policy could not be verified. */</span></div><div class="line">}</div></div><!-- fragment --><p>As always, used resources need to be freed. See previous chapters on how to free the context and result.</p>
<h2>10. Building your own policies </h2>
<p>If the predefined policies do not meet our needs of verification, we can build our own policies. For this we need to put rules (implemented as verification functions) in some order that meets our verification needs. We can reuse predefined rules or define our own rules for this purpose. Let's create a policy based on our own rules, defined in the rules array <code>customRules</code>. Let's name our policy "CustomPolicy".</p>
<div class="fragment"><div class="line"><a class="code" href="../../df/d8a/group__ksi__types.html#gafd6fe07007f33d9684ff4d17472cce70">KSI_Policy</a> *policy = NULL;      <span class="comment">/* Must be freed later. */</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="../../d3/d9a/structKSI__Rule__st.html">KSI_Rule</a> customRules[] = {</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, VerifyingFunction1},</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, VerifyingFunction2},</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, VerifyingFunction3},</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, NULL}                                     <span class="comment">/* Every rule array has to end with this empty rule. */</span></div><div class="line">};</div><div class="line"></div><div class="line">res = <a class="code" href="../../d0/d30/policy_8h.html#a25c6525f037483cbb95d235d6d526224">KSI_Policy_create</a>(ksi, customRules, <span class="stringliteral">&quot;CustomPolicy&quot;</span>, &amp;customPolicy);</div></div><!-- fragment --><p>Each element in <code>customRules</code> array consists of two parts: rule type and a pointer. In our first example, we use the basic rule type <a class="el" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, which means that the second part - pointer - is a pointer to a verifying function. When a policy is verified by <a class="el" href="../../d0/d30/policy_8h.html#a0bbd308fbf1fcd368cd808a434d51163">KSI_SignatureVerifier_verify</a>, it goes through this array and checks the rule type. If the rule type is <a class="el" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, it calls the verifying function and examines the verification result of this function. If the function returns <a class="el" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a> and verification result is <a class="el" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3da81cbad1994b3f8a0eea1f238fed94c2e">KSI_VER_RES_OK</a>, it continues with the next rule in the array and does so until it encounters the final empty rule. In this case the verification is successful. If at some point any of the functions does not return <a class="el" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a> or the verification result is not <a class="el" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3da81cbad1994b3f8a0eea1f238fed94c2e">KSI_VER_RES_OK</a>, the verification fails and no more rules are processed. There is however one exception when the next rule is processed and we will see this in one of the following examples. For now, let's examine the typical verifying function:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> VerifyingFunction1(<a class="code" href="../../dc/d4b/structKSI__VerificationContext__st.html">KSI_VerificationContext</a> *context, <a class="code" href="../../de/df9/structKSI__RuleVerificationResult__st.html">KSI_RuleVerificationResult</a> *result) {</div><div class="line">        <span class="keywordtype">int</span> res = <a class="code" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197aea12c04ae5d9b90930af19ce01dd6f30">KSI_UNKNOWN_ERROR</a>;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (context == NULL || result == NULL) {</div><div class="line">                <span class="comment">/* Unable to complete verification, set KSI_VER_RES_NA as result. */</span></div><div class="line">                result-&gt;<a class="code" href="../../de/df9/structKSI__RuleVerificationResult__st.html#acfa02ac7d150b81a81e3e42cae429e4a">resultCode</a> = <a class="code" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3da7e8591aa9bb04b46f1b48afa5b0236b3">KSI_VER_RES_NA</a>;</div><div class="line">                result-&gt;<a class="code" href="../../de/df9/structKSI__RuleVerificationResult__st.html#a1428e3d9deed6970e943f7a3414d3f45">errorCode</a> = KSI_VER_ERR_GEN_2;</div><div class="line">                <span class="comment">/* Return relevant error code. */</span></div><div class="line">                res = <a class="code" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a9760985819768d47b4772742f5316a8e">KSI_INVALID_ARGUMENT</a>;</div><div class="line">                <span class="keywordflow">goto</span> cleanup;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* Perform some sort of verification of the signature. */</span></div><div class="line">        <span class="keywordflow">if</span> (!success) {</div><div class="line">                <span class="comment">/* Set KSI_VER_RES_FAIL as result and set appropriate error code. */</span></div><div class="line">                result-&gt;<a class="code" href="../../de/df9/structKSI__RuleVerificationResult__st.html#acfa02ac7d150b81a81e3e42cae429e4a">resultCode</a> = <a class="code" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3daf8eab89825e59206118d3c39365f282e">KSI_VER_RES_FAIL</a>;</div><div class="line">                result-&gt;<a class="code" href="../../de/df9/structKSI__RuleVerificationResult__st.html#a1428e3d9deed6970e943f7a3414d3f45">errorCode</a> = KSI_VER_ERR_CUST_1;</div><div class="line">                <span class="comment">/* Return KSI_OK because verification was completed. */</span></div><div class="line">                res = <a class="code" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>;</div><div class="line">        } <span class="keywordflow">else</span> {</div><div class="line">                <span class="comment">/* Set KSI_VER_RES_OK as result. */</span></div><div class="line">                result-&gt;<a class="code" href="../../de/df9/structKSI__RuleVerificationResult__st.html#acfa02ac7d150b81a81e3e42cae429e4a">resultCode</a> = <a class="code" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3da81cbad1994b3f8a0eea1f238fed94c2e">KSI_VER_RES_OK</a>;</div><div class="line">                result-&gt;<a class="code" href="../../de/df9/structKSI__RuleVerificationResult__st.html#a1428e3d9deed6970e943f7a3414d3f45">errorCode</a> = <a class="code" href="../../d0/d30/policy_8h.html#ae7601ede125f74318a31f085dc5d3e7eaa221d37d15acc649f92391900117965f">KSI_VER_ERR_NONE</a>;</div><div class="line">                <span class="comment">/* Return KSI_OK because verification was completed. */</span></div><div class="line">                res = <a class="code" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>;</div><div class="line">        }</div><div class="line"></div><div class="line">cleanup:</div><div class="line">        <span class="comment">/* Perform cleanup of resources, if needed. */</span></div><div class="line">        <span class="keywordflow">return</span> res;</div><div class="line">}</div></div><!-- fragment --><p>Important points to remember about a verifying function:</p><ol type="1">
<li>Regardless of verification success or failure, the return code in <code>should</code> be <a class="el" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>, indicating that the function had enough input data and was able to reach a conclusion about the correctness of the data.</li>
<li>The only case where the return code should be anything other than <a class="el" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a> is when the function encounters an internal error (e.g. is not able to allocate a resource, cannot find a publications file, is not able to connect to the extender, etc.) or cannot use the provided input data (e.g. a mandatory parameter is NULL, data is in the wrong format, etc.). A relevant error code should then be returned to indicate the reason why verification was not completed.</li>
</ol>
<p>Time to move on to some more complex rules. Let's say we want to provide alternative, equally conclusive paths to a verification result. Path A means that we would have to go through a set of three rules, path B requires verification of a different set of four rules and path C consists of yet another set of two rules. Finally, after succeeding at either path A, B, or C, we still want to run some final rule before deciding on the result of the policy. We can write it down like this:</p>
<div class="fragment"><div class="line"><a class="code" href="../../df/d8a/group__ksi__types.html#gafd6fe07007f33d9684ff4d17472cce70">KSI_Policy</a> *complexPolicy = NULL;       <span class="comment">/* Must be freed later. */</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="../../d3/d9a/structKSI__Rule__st.html">KSI_Rule</a> pathARules[] = {</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, VerifyingFunction1},</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, VerifyingFunction2},</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, VerifyingFunction3},</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, NULL}                                     <span class="comment">/* Every rule array has to end with this empty rule. */</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="../../d3/d9a/structKSI__Rule__st.html">KSI_Rule</a> pathBRules[] = {</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, VerifyingFunction4},</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, VerifyingFunction5},</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, VerifyingFunction6},</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, VerifyingFunction7},</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, NULL}                                     <span class="comment">/* Every rule array has to end with this empty rule. */</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="../../d3/d9a/structKSI__Rule__st.html">KSI_Rule</a> pathCRules[] = {</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, VerifyingFunction8},</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, VerifyingFunction9},</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, NULL}                                     <span class="comment">/* Every rule array has to end with this empty rule. */</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="../../d3/d9a/structKSI__Rule__st.html">KSI_Rule</a> chooseABCRule[] = {</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba8e84ad96455dbf511c38904d7e24284c">KSI_RULE_TYPE_COMPOSITE_OR</a>, pathARules},</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba8e84ad96455dbf511c38904d7e24284c">KSI_RULE_TYPE_COMPOSITE_OR</a>, pathBRules},</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba8e84ad96455dbf511c38904d7e24284c">KSI_RULE_TYPE_COMPOSITE_OR</a>, pathCRules},</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, NULL}                                     <span class="comment">/* Every rule array has to end with this empty rule. */</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="../../d3/d9a/structKSI__Rule__st.html">KSI_Rule</a> complexRules[] = {</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba25ec886dd9194a882bf322f2d8537926">KSI_RULE_TYPE_COMPOSITE_AND</a>, chooseABCRule},</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, VerifyingFunction10},</div><div class="line">        {<a class="code" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba6a4d14c5117189b392b9cf8404b2044b">KSI_RULE_TYPE_BASIC</a>, NULL}                                     <span class="comment">/* Every rule array has to end with this empty rule. */</span></div><div class="line">};</div><div class="line"></div><div class="line">res = <a class="code" href="../../d0/d30/policy_8h.html#a25c6525f037483cbb95d235d6d526224">KSI_Policy_create</a>(ksi, complexRules, <span class="stringliteral">&quot;ComplexPolicy&quot;</span>, &amp;complexPolicy);</div></div><!-- fragment --><p>We introduced two new rule types here: <a class="el" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba8e84ad96455dbf511c38904d7e24284c">KSI_RULE_TYPE_COMPOSITE_OR</a> and <a class="el" href="../../d0/d30/policy_8h.html#a68605fadc263f3f6f47f842f1235f72ba25ec886dd9194a882bf322f2d8537926">KSI_RULE_TYPE_COMPOSITE_AND</a>. Both are composite rule types, which means that the second part of the rule - the pointer - is not a function pointer (as was the case with the basic rule type), but instead a pointer to another array of rules. The array of rules can contain both basic and composite rules, meaning that composite rules can be nested. As you would expect from any array of rules, the composite rule is also also verified in a linear fashion until a rule fails or until all rules including the last one are successful.</p>
<p>The result of the composite rule, whether success or failure, is interpreted according to the rule type. If an OR-type rule is successfully verified, further rules in the rule array are skipped and the whole rule of which the OR-type rule is part of, is considered successfully verified. In our example, if <code>pathARules</code> verifies successfully, the subsequent rules <code>pathBRules</code> and <code>pathCRules</code> are skipped and the rule <code>chooseABCRule</code> is considered successful. The analogy to an OR-statement continues, but with a slightly different definition of failure - if an OR-type rule result is inconclusive (<a class="el" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3da7e8591aa9bb04b46f1b48afa5b0236b3">KSI_VER_RES_NA</a>), we are allowed to verify the the next rule in the array. However, if an OR-type rule result fails with <a class="el" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3daf8eab89825e59206118d3c39365f282e">KSI_VER_RES_FAIL</a>, subsequent rules are not verified and the result of array of rules is a failure. So in our example, if <code>pathARules</code> results in <a class="el" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3da7e8591aa9bb04b46f1b48afa5b0236b3">KSI_VER_RES_NA</a>, the rule <code>pathBRules</code> is verified. If this rule result is also inconclusive, the rule <code>pathCRules</code> is verified. If however any of those rules fail with <a class="el" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3daf8eab89825e59206118d3c39365f282e">KSI_VER_RES_FAIL</a>, the rule <code>chooseABCRule</code> has also failed.</p>
<p>In our example the rule <code>chooseABCRule</code> itself is a composite AND-type rule, which means that its result must be successful for the verification to continue. So for a successful result of our <code>complexPolicy</code>, both <code>chooseABCRule</code> and <code>VerifyingFunction10</code> must verify successfully. If an AND-type rule fails, the whole rule array of which it is part of, fails as well (no further rules are verified).</p>
<p>Let's summarize how rule results are interpreted:</p><ol type="1">
<li>If the return code is not <a class="el" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>, the rule has failed due to some internal error. No further rules are checked and the return code is propagated upwards to the top level rule, concluding with a failure of the policy.</li>
<li>If the return code is <a class="el" href="../../dd/df2/group__base.html#gga80cba280da561d1b02728cd946645197a457f8614f99ec7a367d4ca638f0fcdaa">KSI_OK</a>, the rule was verified and its result must be examined.</li>
<li>A basic rule or a composite AND-type rule is considered successful if the result is <a class="el" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3da81cbad1994b3f8a0eea1f238fed94c2e">KSI_VER_RES_OK</a>. In this case the verification continues with the next rule on the same level.</li>
<li>A composite OR-type rule is considered successful if the result is <a class="el" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3da81cbad1994b3f8a0eea1f238fed94c2e">KSI_VER_RES_OK</a>. Further rules on the same level are skipped and verification continues one level higher.</li>
<li>Any rule is considered a failure if the result is <a class="el" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3daf8eab89825e59206118d3c39365f282e">KSI_VER_RES_FAIL</a>. No further rules are checked and the result is propagated upwards to the top level rule, concluding with a failure of the policy.</li>
<li>A basic rule or a composite AND-type rule is considered inconclusive if the result is <a class="el" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3da7e8591aa9bb04b46f1b48afa5b0236b3">KSI_VER_RES_NA</a>. The result is propagated one level upwards, but further rules on the same level are skipped. Verification may stop or continue depending on rule types of the upper level rules.</li>
<li>A composite OR-type rule is considered inconclusive if the result code is <a class="el" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3da7e8591aa9bb04b46f1b48afa5b0236b3">KSI_VER_RES_NA</a>. The result is ignored and the next rule on the same level is checked. This is the only exception where verification is guaranteed to continue even if the result is not <a class="el" href="../../d0/d30/policy_8h.html#ade6a0e8d25997659464663a446f17d3da81cbad1994b3f8a0eea1f238fed94c2e">KSI_VER_RES_OK</a>.</li>
<li>The result of the last checked rule on any level is always propagated one level higher.</li>
</ol>
<p>For an additional level of customization we can chain policies to each other to allow automatic fallback to a different verification policy if the original policy fails. For our own policies that we have created with <a class="el" href="../../d0/d30/policy_8h.html#a25c6525f037483cbb95d235d6d526224">KSI_Policy_create</a>, we can set the fallback policy pointer by calling <a class="el" href="../../d0/d30/policy_8h.html#aba2678d67c3984d6e3d05718b9206fe0">KSI_Policy_setFallback</a>. If we want to use one of the predefined policies as the original policy, we first need to clone it by calling <a class="el" href="../../d0/d30/policy_8h.html#a72b0613717a62fdfe0d18bf2c0175825">KSI_Policy_clone</a>. When we have created or cloned a policy, we also need to free it after use by calling <a class="el" href="../../d0/d30/policy_8h.html#aeb694a0ae972c4ecf8a895240a744a46">KSI_Policy_free</a>.</p>
<div class="fragment"><div class="line"><span class="comment">/* Chaining our own policies: customPolicy-&gt;complexPolicy */</span></div><div class="line">res = <a class="code" href="../../d0/d30/policy_8h.html#a25c6525f037483cbb95d235d6d526224">KSI_Policy_create</a>(ksi, customRules, <span class="stringliteral">&quot;CustomPolicy&quot;</span>, &amp;customPolicy);</div><div class="line">res = <a class="code" href="../../d0/d30/policy_8h.html#a25c6525f037483cbb95d235d6d526224">KSI_Policy_create</a>(ksi, complexRules, <span class="stringliteral">&quot;ComplexPolicy&quot;</span>, &amp;complexPolicy);</div><div class="line">res = <a class="code" href="../../d0/d30/policy_8h.html#aba2678d67c3984d6e3d05718b9206fe0">KSI_Policy_setFallback</a>(ksi, customPolicy, complexPolicy);</div><div class="line"><span class="comment">/* Set up the verification context. */</span></div><div class="line">res = <a class="code" href="../../d0/d30/policy_8h.html#a0bbd308fbf1fcd368cd808a434d51163">KSI_SignatureVerifier_verify</a>(customPolicy, &amp;context, &amp;result);</div><div class="line"><span class="comment">/* Error handling. */</span></div><div class="line"><a class="code" href="../../d0/d30/policy_8h.html#aeb694a0ae972c4ecf8a895240a744a46">KSI_Policy_free</a>(customPolicy);</div><div class="line"><a class="code" href="../../d0/d30/policy_8h.html#aeb694a0ae972c4ecf8a895240a744a46">KSI_Policy_free</a>(complexPolicy);</div><div class="line"></div><div class="line"><span class="comment">/* Chaining predefined policies: key based -&gt; publications file based */</span></div><div class="line">res = <a class="code" href="../../d0/d30/policy_8h.html#a72b0613717a62fdfe0d18bf2c0175825">KSI_Policy_clone</a>(ksi, KSI_VERIFICATION_POLICY_KEY_BASED, &amp;clonedPolicy);</div><div class="line">res = <a class="code" href="../../d0/d30/policy_8h.html#aba2678d67c3984d6e3d05718b9206fe0">KSI_Policy_setFallback</a>(ksi, clonedPolicy, KSI_VERIFICATION_POLICY_PUBLICATIONS_FILE_BASED);</div><div class="line"><span class="comment">/* Set up the verification context. */</span></div><div class="line">res = <a class="code" href="../../d0/d30/policy_8h.html#a0bbd308fbf1fcd368cd808a434d51163">KSI_SignatureVerifier_verify</a>(clonedPolicy, &amp;context, &amp;result);</div><div class="line"><span class="comment">/* Error handling. */</span></div><div class="line"><a class="code" href="../../d0/d30/policy_8h.html#aeb694a0ae972c4ecf8a895240a744a46">KSI_Policy_free</a>(clonedPolicy);</div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
